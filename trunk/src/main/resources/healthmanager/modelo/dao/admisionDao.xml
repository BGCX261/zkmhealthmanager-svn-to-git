<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="healthmanager.modelo.dao.AdmisionDao">

	<resultMap id="admisionMap" type="admision">
		<result column="codigo_empresa" property="codigo_empresa" />
		<result column="codigo_sucursal" property="codigo_sucursal" />
		<result column="nro_ingreso" property="nro_ingreso" />
		<result column="nro_identificacion" property="nro_identificacion" />
		<result column="codigo_administradora" property="codigo_administradora" />
		<result column="id_plan" property="id_plan" />
		<result column="codigo_medico" property="codigo_medico" />
		<result column="estado" property="estado" />
		<result column="fecha_ingreso" property="fecha_ingreso" />
		<result column="nro_autorizacion" property="nro_autorizacion" />
		<result column="via_ingreso" property="via_ingreso" />
		<result column="tipo_atencion" property="tipo_atencion" />
		<result column="codigo_especialidad" property="codigo_especialidad" />
		<result column="cama" property="cama" />
		<result column="ingreso_programa" property="ingreso_programa" />
		<result column="primera_vez" property="primera_vez" />
		<result column="condicion_usuaria" property="condicion_usuaria" />
		<result column="causa_externa" property="causa_externa" />
		<result column="tipo_diagnostico" property="tipo_diagnostico" />
		<result column="diagnostico_ingreso" property="diagnostico_ingreso" />
		<result column="tipo_discapacidad" property="tipo_discapacidad" />
		<result column="grado_discapacidad" property="grado_discapacidad" />
		<result column="creacion_date" property="creacion_date" />
		<result column="ultimo_update" property="ultimo_update" />
		<result column="delete_date" property="delete_date" />
		<result column="creacion_user" property="creacion_user" />
		<result column="ultimo_user" property="ultimo_user" />
		<result column="delete_user" property="delete_user" />
		<result column="urgencias" property="urgencias" />
		<result column="hospitalizacion" property="hospitalizacion" />
		<result column="recien_nacido" property="recien_nacido" />
		<result column="atendida" property="atendida" />
		<result column="atendiendo" property="atendiendo" />
		<result column="codigo_cita" property="codigo_cita" />
		<result column="tipo_consulta" property="tipo_consulta" />
		<result column="aplica_triage" property="aplica_triage" />
		<result column="realizo_triage" property="realizo_triage" />
		<result column="aplica_tuberculosis" property="aplica_tuberculosis" />
		<result column="codigo_orden" property="codigo_orden" />
		<result column="aplica_lepra" property="aplica_lepra" />
		<result column="tipo_adicional_via_ingreso" property="tipo_adicional_via_ingreso" />
		<result column="fecha_atencion" property="fecha_atencion" />
		<result column="admision_parto" property="admision_parto" />
		<result column="codigo_centro" property="codigo_centro" />
		<result column="paciente_remitido" property="paciente_remitido" />

		<result column="pcodigo_empresa" property="paciente.codigo_empresa" />
		<result column="pcodigo_sucursal" property="paciente.codigo_sucursal" />
		<result column="pnro_identificacion" property="paciente.nro_identificacion" />
		<result column="pdocumento" property="paciente.documento" />
		<result column="pnombre1" property="paciente.nombre1" />
		<result column="pnombre2" property="paciente.nombre2" />
		<result column="papellido1" property="paciente.apellido1" />
		<result column="papellido2" property="paciente.apellido2" />
		<result column="ptipo_identificacion" property="paciente.tipo_identificacion" />
		<result column="pcodigo_educativo" property="paciente.codigo_educativo" />
		<result column="ppertenencia_etnica" property="paciente.pertenencia_etnica" />
		<result column="psexo" property="paciente.sexo" />
		<result column="pdireccion" property="paciente.direccion" />
		<result column="ptel_res" property="paciente.tel_res" />
		<result column="ptel_oficina" property="paciente.tel_oficina" />
		<result column="pfecha_nacimiento" property="paciente.fecha_nacimiento" />
		<result column="pestado_civil" property="paciente.estado_civil" />
		<result column="pestado_civil" property="paciente.estado_civil" />
		<result column="pestado_civil" property="paciente.estado_civil" />
		<result column="pcodigo_ocupacion" property="paciente.codigo_ocupacion" />
		<result column="pcodigo_dpto" property="paciente.codigo_dpto" />
		<result column="pcodigo_municipio" property="paciente.codigo_municipio" />
		<result column="ptipo_usuario" property="paciente.tipo_usuario" />
		<result column="punidad_medidad" property="paciente.unidad_medidad" />
		<result column="pidentificacion_madre" property="paciente.identificacion_madre" />

		<result column="evi_codigo" property="elemento_via_ingreso.codigo" />
		<result column="evi_tipo" property="elemento_via_ingreso.tipo" />
		<result column="evi_descripcion" property="elemento_via_ingreso.descripcion" />

		<result column="acodigo_administradora" property="administradora.codigo" />
		<result column="anombre_administradora" property="administradora.nombre" />

		<result column="nombres_prestador" property="prestadores.nombres" />
		<result column="apellidos_prestador" property="prestadores.apellidos" />

		<result column="plid_plan" property="contratos.id_plan" />
		<result column="plnombre_plan" property="contratos.nombre" />
		<result column="procedencia" property="procedencia" />
		<result column="fecha_apertura" property="fecha_apertura" />
		<result column="particular" property="particular" />
		<result column="marca_admision" property="marca_admision" />
		<result column="tipo_psicologia" property="tipo_psicologia" />
		<result column="motivo_cancelacion" property="motivo_cancelacion" />
		<result column="facturadas_manual" property="facturadas_manual" />
		<result column="programa_lab_pyp" property="programa_lab_pyp" />


	</resultMap>

	<insert id="crear" parameterType="admision">
		insert into public.admision
		(codigo_empresa,codigo_sucursal,
		nro_ingreso,nro_identificacion,codigo_administradora,
		id_plan,codigo_medico,estado,
		fecha_ingreso,nro_autorizacion,via_ingreso,
		tipo_atencion,codigo_especialidad,cama,
		ingreso_programa,primera_vez,condicion_usuaria,
		causa_externa,tipo_diagnostico,diagnostico_ingreso,
		tipo_discapacidad,grado_discapacidad,creacion_date,
		ultimo_update,delete_date,creacion_user,
		ultimo_user,delete_user,urgencias,
		hospitalizacion,recien_nacido,atendida,
		codigo_cita,tipo_consulta,aplica_triage,
		realizo_triage,aplica_tuberculosis,codigo_orden,
		aplica_lepra,tipo_adicional_via_ingreso,fecha_atencion,
		admision_parto,codigo_centro,paciente_remitido,
		atendiendo,procedencia,fecha_apertura,
		particular,marca_admision,tipo_psicologia,motivo_cancelacion,facturadas_manual,
		programa_lab_pyp)

		values
		(#{codigo_empresa},#{codigo_sucursal},
		#{nro_ingreso},#{nro_identificacion},#{codigo_administradora},
		#{id_plan},#{codigo_medico},#{estado},
		#{fecha_ingreso},#{nro_autorizacion},#{via_ingreso},
		#{tipo_atencion},#{codigo_especialidad},#{cama},
		#{ingreso_programa},#{primera_vez},#{condicion_usuaria},
		#{causa_externa},#{tipo_diagnostico},#{diagnostico_ingreso},
		#{tipo_discapacidad},#{grado_discapacidad},#{creacion_date},
		#{ultimo_update},#{delete_date},#{creacion_user},
		#{ultimo_user},#{delete_user},#{urgencias},
		#{hospitalizacion},#{recien_nacido},#{atendida},
		#{codigo_cita},#{tipo_consulta},#{aplica_triage},
		#{realizo_triage},#{aplica_tuberculosis},#{codigo_orden},
		#{aplica_lepra},#{tipo_adicional_via_ingreso},#{fecha_atencion},
		#{admision_parto},#{codigo_centro},#{paciente_remitido},
		#{atendiendo},#{procedencia},#{fecha_apertura},
		#{particular},#{marca_admision},#{tipo_psicologia},#{motivo_cancelacion},#{facturadas_manual},
		#{programa_lab_pyp})
	</insert>

	<update id="actualizar_estado" parameterType="admision">
		update
		public.admision set
		atendida = #{atendida},
		atendiendo = #{atendiendo},
		estado = #{estado}
		where
		codigo_empresa = #{codigo_empresa}
		and
		codigo_sucursal = #{codigo_sucursal}
		and nro_ingreso = #{nro_ingreso}
		and nro_identificacion = #{nro_identificacion}
	</update>

	<update id="actualizar" parameterType="admision">
		update public.admision set
		codigo_empresa = #{codigo_empresa},
		codigo_sucursal =
		#{codigo_sucursal},nro_ingreso = #{nro_ingreso},
		nro_identificacion =
		#{nro_identificacion},codigo_administradora =
		#{codigo_administradora},
		id_plan = #{id_plan},codigo_medico =
		#{codigo_medico},
		estado = #{estado},fecha_ingreso = #{fecha_ingreso},
		nro_autorizacion = #{nro_autorizacion},via_ingreso = #{via_ingreso},
		tipo_atencion = #{tipo_atencion},codigo_especialidad =
		#{codigo_especialidad},
		cama = #{cama},ingreso_programa =
		#{ingreso_programa},
		primera_vez = #{primera_vez},condicion_usuaria =
		#{condicion_usuaria},
		causa_externa = #{causa_externa},tipo_diagnostico
		= #{tipo_diagnostico},
		diagnostico_ingreso =
		#{diagnostico_ingreso},tipo_discapacidad = #{tipo_discapacidad},
		grado_discapacidad = #{grado_discapacidad},
		<!-- creacion_date = #{creacion_date}, -->
		ultimo_update = #{ultimo_update},delete_date =
		#{delete_date},
		<!-- creacion_user = #{creacion_user}, -->
		ultimo_user =
		#{ultimo_user},
		delete_user = #{delete_user},urgencias =
		#{urgencias},
		hospitalizacion = #{hospitalizacion},recien_nacido =
		#{recien_nacido},
		atendida = #{atendida},
		atendiendo = #{atendiendo}
		,codigo_cita =
		#{codigo_cita},
		tipo_consulta =
		#{tipo_consulta},aplica_triage =
		#{aplica_triage},
		realizo_triage =
		#{realizo_triage},aplica_tuberculosis = #{aplica_tuberculosis},
		codigo_orden = #{codigo_orden},aplica_lepra = #{aplica_lepra},
		tipo_adicional_via_ingreso =
		#{tipo_adicional_via_ingreso},fecha_atencion = #{fecha_atencion},
		admision_parto = #{admision_parto}, codigo_centro = #{codigo_centro},
		paciente_remitido = #{paciente_remitido},
		procedencia = #{procedencia},
		fecha_apertura=#{fecha_apertura}, particular = #{particular},
		marca_admision = #{marca_admision},
		tipo_psicologia =
		#{tipo_psicologia},
		motivo_cancelacion=#{motivo_cancelacion},facturadas_manual=#{facturadas_manual},
		programa_lab_pyp = #{programa_lab_pyp}
		where
		codigo_empresa =
		#{codigo_empresa}
		and codigo_sucursal =
		#{codigo_sucursal}
		and
		nro_ingreso = #{nro_ingreso}
		and
		nro_identificacion =
		#{nro_identificacion}
	</update>

	<select id="consultar" resultMap="admisionMap" parameterType="admision">
		select codigo_empresa,codigo_sucursal,
		nro_ingreso,nro_identificacion,codigo_administradora,id_plan,
		codigo_medico,estado,fecha_ingreso,nro_autorizacion,
		via_ingreso,tipo_atencion,codigo_especialidad,cama,
		ingreso_programa,primera_vez,condicion_usuaria,causa_externa,
		tipo_diagnostico,diagnostico_ingreso,tipo_discapacidad,grado_discapacidad,
		creacion_date,ultimo_update,delete_date,creacion_user,
		ultimo_user,delete_user,urgencias,hospitalizacion,
		recien_nacido,atendida,atendiendo,codigo_cita,
		aplica_triage,
		realizo_triage,
		aplica_tuberculosis,
		codigo_orden,aplica_lepra,tipo_consulta,
		tipo_adicional_via_ingreso,fecha_atencion,
		admision_parto,
		codigo_centro,paciente_remitido,procedencia,
		fecha_apertura,particular,marca_admision,
		tipo_psicologia,motivo_cancelacion,facturadas_manual,
		programa_lab_pyp,
		documento as pdocumento,
		nro_identificacion AS
		pnro_identificacion,
		codigo_empresa as pcodigo_empresa,
		codigo_sucursal
		as pcodigo_sucursal,
		codigo_administradora as pcodigo_administradora,
		nombre1 as
		pnombre1,
		nombre2 as pnombre2,
		apellido1 as
		papellido1,
		apellido2 as
		papellido2,
		tipo_identificacion as
		ptipo_identificacion,
		codigo_educativo as
		pcodigo_educativo,
		pertenencia_etnica as
		ppertenencia_etnica,
		sexo as
		psexo,
		direccion as pdireccion,
		tel_res as
		ptel_res,
		tel_oficina as
		ptel_oficina,
		fecha_nacimiento as
		pfecha_nacimiento,
		estado_civil
		as
		pestado_civil,
		codigo_ocupacion as
		pcodigo_ocupacion,
		codigo_dpto
		as
		pcodigo_dpto,
		codigo_municipio
		as
		pcodigo_municipio,
		tipo_usuario as
		ptipo_usuario,
		unidad_medidad
		as
		punidad_medidad,
		identificacion_madre as
		pidentificacion_madre,
		codigo_ving as
		evi_codigo,
		tipo_ving as evi_tipo,
		descripcion_ving as
		evi_descripcion,
		codigo_administradora as
		acodigo_administradora,
		nombre_administradora as
		anombre_administradora,
		nombre_plan as
		plnombre_plan
		from public.vr_admision
		WHERE
		codigo_empresa =
		#{codigo_empresa}
		AND codigo_sucursal = #{codigo_sucursal}
		AND
		nro_identificacion = #{nro_identificacion}
		<if test="nro_ingreso != null">
			AND nro_ingreso = #{nro_ingreso}
		</if>
		<if test="codigo_cita != null">
			AND codigo_cita = #{codigo_cita}
		</if>
	</select>

	<!-- Esto complementa -->
	<sql id="sql_complementacion_eliminacion">
		WHERE codigo_empresa = #{codigo_empresa}
		and codigo_sucursal
		=
		#{codigo_sucursal} and nro_ingreso = #{nro_ingreso}
		and
		nro_identificacion = #{nro_identificacion}
	</sql>

	<delete id="eliminar" parameterType="admision">
		UPDATE public.admision SET delete_user = #{delete_user}
		<include refid="sql_complementacion_eliminacion" />
		;
		DELETE from public.admision
		<include refid="sql_complementacion_eliminacion" />
		;
	</delete>

	<select id="listarTabla" resultMap="admisionMap" parameterType="java.util.Map">
		select admision.codigo_empresa,admision.codigo_sucursal,
		admision.nro_ingreso,admision.nro_identificacion,admision.codigo_administradora,admision.id_plan,
		admision.codigo_medico,admision.estado,admision.fecha_ingreso,admision.nro_autorizacion,
		admision.via_ingreso,admision.tipo_atencion,admision.codigo_especialidad,admision.cama,
		admision.ingreso_programa,admision.primera_vez,admision.condicion_usuaria,admision.causa_externa,
		admision.tipo_diagnostico,admision.diagnostico_ingreso,admision.tipo_discapacidad,admision.grado_discapacidad,
		admision.creacion_date,admision.ultimo_update,admision.delete_date,admision.creacion_user,
		admision.ultimo_user,admision.delete_user,admision.urgencias,admision.hospitalizacion,
		admision.recien_nacido,admision.atendida,admision.atendiendo,admision.codigo_cita,
		admision.aplica_triage,admision.realizo_triage,
		admision.aplica_tuberculosis,
		admision.codigo_orden,admision.aplica_lepra,admision.tipo_consulta,
		admision.tipo_adicional_via_ingreso,admision.fecha_atencion,
		admision.admision_parto,admision.codigo_centro,
		admision.paciente_remitido,admision.procedencia,
		admision.fecha_apertura,admision.particular,admision.marca_admision,
		admision.tipo_psicologia,admision.motivo_cancelacion,admision.facturadas_manual,
		admision.programa_lab_pyp
		from public.admision
		<trim prefix="WHERE" prefixOverrides="AND |OR ">
			<if test="codigo_empresa != null">AND admision.codigo_empresa = #{codigo_empresa}</if>
			<if test="codigo_sucursal != null">AND admision.codigo_sucursal = #{codigo_sucursal}</if>
			<if test="nro_identificacion != null">AND admision.nro_identificacion = #{nro_identificacion}
			</if>
			<if test="codigo_administradora != null">AND admision.codigo_administradora =
				#{codigo_administradora}
			</if>
			<if test="id_plan != null">AND admision.id_plan = #{id_plan}</if>
			<if test="no_ingreso != null">AND admision.nro_ingreso != #{no_ingreso}</if>
			<if test="nro_ingreso != null">AND admision.nro_ingreso = #{nro_ingreso}</if>
			<if test="estado != null">AND admision.estado = #{estado}</if>
			<if test="atendida != null">AND admision.atendida = #{atendida}</if>
			<if test="atendiendo != null">AND admision.atendiendo = #{atendiendo}</if>
			<if test="via_ingreso_cons != null">AND admision.via_ingreso = #{via_ingreso_cons}</if>
			<if test="via_ingreso_urg != null">AND admision.via_ingreso = #{via_ingreso_urg}</if>
			<if test="via_ingreso != null">AND admision.via_ingreso = #{via_ingreso}</if>
			<if test="codigo_medico != null">AND (admision.codigo_medico = #{codigo_medico} or
				admision.codigo_medico = '000000000')
			</if>
			<if test="facturadas_manual != null">
				AND admision.facturadas_manual = #{facturadas_manual}
			</if>
			<if test="fecha_apertura != null">AND admision.fecha_apertura is not null</if>
			<if test="creacion_user != null">AND (admision.creacion_user = #{creacion_user})</if>
			<if test="codigo_medico_mod != null">AND (admision.codigo_medico = #{codigo_medico_mod})</if>
			<if test="fecha != null">AND cast(admision.fecha_ingreso as varchar) like
				'${fecha}%'</if>
			<if test="causa_externa">AND admision.causa_externa = #{causa_externa}</if>
			<if test="aplica_triage != null">
				AND admision.aplica_triage = #{aplica_triage}
			</if>
			<if test="realizo_triage != null">
				AND admision.realizo_triage = #{realizo_triage}
			</if>
			<if test="marca_admision !=null">
				AND admision.marca_admision = #{marca_admision}
			</if>

			<if test="validacion_tipo_historia != null">
				AND (admision.primera_vez = 'N' OR
				(admision.primera_vez =
				'S' AND admision.via_ingreso = '14'))
			</if>
			<if test="filtro_urgencias != null">
				AND (admision.aplica_triage = false OR
				(admision.aplica_triage = true AND admision.realizo_triage = true
				AND admision.estado='1'))
			</if>
			<if test="vias_ingreso != null">
				AND admision.via_ingreso IN
				<foreach collection="vias_ingreso" item="i" open="("
					separator="," close=")">
					#{i}
				</foreach>
			</if>
			<if test="vias_ingreso_excluyentes != null">
				AND admision.via_ingreso NOT IN
				<foreach collection="vias_ingreso_excluyentes" item="i"
					open="(" separator="," close=")">
					#{i}
				</foreach>
			</if>
			<if test="tipo_adicional_via_ingreso != null">
				AND admision.tipo_adicional_via_ingreso IN
				<foreach collection="tipo_adicional_via_ingreso" item="adicional"
					open="(" separator="," close=")">
					#{adicional}
				</foreach>
			</if>
			<if test="causa_externa_in != null">
				AND admision.causa_externa IN
				<foreach collection="causa_externa_in" item="i" open="("
					separator="," close=")">
					#{i}
				</foreach>
			</if>

			<if test="codigo_centro != null">
				AND admision.codigo_centro = #{codigo_centro}
			</if>

			<if test="centro_atencion != null">
				AND admision.codigo_centro = #{centro_atencion}
			</if>
			<if test="fecha_inicial_p != null">
				<![CDATA[
				AND (cast(fecha_ingreso as date) >= cast(#{fecha_inicial_p} as date))
				]]>
			</if>

			<if test="fecha_final_p != null">
				<![CDATA[
				AND (cast(fecha_ingreso as date) <= cast(#{fecha_final_p} as date))
				]]>
			</if>

			<if test="rango_fecha != null">
				and cast(fecha_ingreso as date) between
				cast(#{fecha_inicio} as date)
				and cast(#{fecha_final} as date)
			</if>
		</trim>
		<if test="order != null">
			order by ${order}
		</if>
		<if test="order == null">
			order by admision.fecha_ingreso
			desc,admision.estado,admision.nro_ingreso
			desc
		</if>
		<if test="limite_paginado != null">
			${limite_paginado}
		</if>
	</select>

	<select id="listarResultados" resultMap="admisionMap"
		parameterType="java.util.Map">
		select codigo_empresa,
		codigo_sucursal,
		nro_ingreso,
		nro_identificacion,
		codigo_administradora,
		nombre_administradora as
		anombre_administradora,
		id_plan,
		nombre1 as pnombre1,
		nombre2 as pnombre2,
		apellido1 as
		papellido1,
		apellido2 as papellido2,
		documento as
		pdocumento,
		tipo_identificacion as ptipo_identificacion,
		nombres_prestador,
		apellidos_prestador,
		via_ingreso,
		fecha_ingreso,
		descripcion_ving as
		evi_descripcion,
		marca_admision,
		estado,
		atendida,
		fecha_atencion,
		primera_vez,
		fecha_apertura,
		fecha_nacimiento as pfecha_nacimiento,
		codigo_medico,
		realizo_triage,
		evi_codigo,
		tipo_ving as evi_tipo,
		descripcion_ving as
		evi_descripcion,
		codigo_centro,
		estado,
		facturadas_manual
		from public.vr_admision
		<trim prefix="WHERE" prefixOverrides="AND |OR ">
			<if test="codigo_empresa != null">AND codigo_empresa = #{codigo_empresa}</if>
			<if test="codigo_sucursal != null">AND codigo_sucursal = #{codigo_sucursal}</if>
			<if test="nro_identificacion != null">AND nro_identificacion = #{nro_identificacion}</if>
			<if test="nombre1 != null">AND nombre1 like '%${nombre1}%'</if>
			<if test="nombre2 != null">AND nombre2 like '%${nombre2}%'</if>
			<if test="apellido1 != null">AND apellido1 like '%${apellido1}%'</if>
			<if test="apellido2 != null">AND apellido2 like '%${apellido2}%'</if>
			<if test="codigo_administradora != null">AND codigo_administradora = #{codigo_administradora}</if>
			<if test="id_plan != null">AND id_plan = #{id_plan}</if>
			<if test="no_ingreso != null">AND nro_ingreso != #{no_ingreso}</if>
			<if test="nro_ingreso != null">AND nro_ingreso = #{nro_ingreso}</if>
			<if test="parameter != null">AND ${parameter} like '${value}'</if>
			<if test="estado != null">AND estado = #{estado}</if>
			<if test="atendida != null">AND atendida = #{atendida}</if>
			<if test="atendiendo != null">AND atendiendo = #{atendiendo}</if>
			<if test="via_ingreso_cons != null">AND via_ingreso = #{via_ingreso_cons}</if>
			<if test="via_ingreso_urg != null">AND via_ingreso = #{via_ingreso_urg}</if>
			<if test="via_ingreso != null">AND via_ingreso = #{via_ingreso}</if>
			<if test="codigo_medico != null">AND (codigo_medico = #{codigo_medico} or
				codigo_medico =
				'000000000')
			</if>
			<if test="facturadas_manual != null">
				AND facturadas_manual = #{facturadas_manual}
			</if>
			<if test="fecha_apertura != null">AND fecha_apertura is not null</if>
			<if test="creacion_user != null">AND (creacion_user = #{creacion_user})</if>
			<if test="codigo_medico_mod != null">AND (codigo_medico = #{codigo_medico_mod})</if>
			<if test="fecha != null">AND cast(fecha_ingreso as varchar) like '${fecha}%'</if>
			<if test="fecha_ingreso != null">AND cast(fecha_ingreso as date) = #{fecha_ingreso}</if>
			<if test="causa_externa">AND causa_externa = #{causa_externa}</if>
			<if test="paramTodo != null">AND (
				nro_identificacion like '%${value}%'
				or
				nombre1||'
				'||nombre2 like '%${value}%'
				or apellido1||'
				'||apellido2 like
				'%${value}%'
				or nro_ingreso like '%${value}%'
				)
			</if>
			<if test="aplica_triage != null">
				AND aplica_triage = #{aplica_triage}
			</if>
			<if test="realizo_triage != null">
				AND realizo_triage = #{realizo_triage}
			</if>
			<if test="marca_admision !=null">
				AND marca_admision = #{marca_admision}
			</if>

			<if test="validacion_tipo_historia != null">
				AND (primera_vez = 'N' OR
				(primera_vez =
				'S' AND
				via_ingreso = '14'))
			</if>
			<if test="filtro_urgencias != null">
				AND (aplica_triage = false OR
				(aplica_triage = true AND
				realizo_triage = true AND estado='1'))
			</if>
			<if test="vias_ingreso != null">
				AND via_ingreso IN
				<foreach collection="vias_ingreso" item="i" open="("
					separator="," close=")">
					#{i}
				</foreach>
			</if>
			<if test="vias_ingreso_excluyentes != null">
				AND via_ingreso NOT IN
				<foreach collection="vias_ingreso_excluyentes" item="i"
					open="(" separator="," close=")">
					#{i}
				</foreach>
			</if>

			<if test="tipo_adicional_via_ingreso != null">
				AND tipo_adicional_via_ingreso IN
				<foreach collection="tipo_adicional_via_ingreso" item="adicional"
					open="(" separator="," close=")">
					#{adicional}
				</foreach>
			</if>
			<if test="causa_externa_in != null">
				AND causa_externa IN
				<foreach collection="causa_externa_in" item="i" open="("
					separator="," close=")">
					#{i}
				</foreach>
			</if>

			<if test="codigo_centro != null">
				AND codigo_centro = #{codigo_centro}
			</if>

			<if test="centro_atencion != null">
				AND codigo_centro = #{centro_atencion}
			</if>

			<if test="listado_centros != null">
				AND codigo_centro IN
				<foreach collection="listado_centros" item="i" open="("
					separator="," close=")">
					#{i}
				</foreach>
			</if>

			<if test="fecha_inicial_p != null">
				<![CDATA[
 				AND (cast(fecha_ingreso as date) >= cast(#{fecha_inicial_p} as date)) 
				]]>
			</if>

			<if test="fecha_final_p != null">
				<![CDATA[
				AND (cast(fecha_ingreso as date) <= cast(#{fecha_final_p} as date)) 
				]]>
			</if>

			<if test="rango_fecha != null">
				and cast(fecha_ingreso as date) between
				cast(#{fecha_inicio} as date)
				and cast(#{fecha_final} as date)
			</if>
		</trim>
		<if test="order != null">
			order by ${order}
		</if>
		<if test="order_defecto != null">
			order by fecha_ingreso DESC
		</if>
		<if test="limite_paginado != null">
			${limite_paginado}
		</if>
	</select>



	<select id="totalResultados" resultType="java.lang.Integer"
		parameterType="java.util.Map">
		select
		count(1)
		from public.vr_admision
		<trim prefix="WHERE" prefixOverrides="AND |OR ">
			<if test="codigo_empresa != null">AND codigo_empresa = #{codigo_empresa}</if>
			<if test="codigo_sucursal != null">AND codigo_sucursal = #{codigo_sucursal}</if>
			<if test="nro_identificacion != null">AND nro_identificacion = #{nro_identificacion}</if>
			<if test="codigo_administradora != null">AND codigo_administradora = #{codigo_administradora}</if>
			<if test="id_plan != null">AND id_plan = #{id_plan}</if>
			<if test="no_ingreso != null">AND nro_ingreso != #{no_ingreso}</if>
			<if test="nro_ingreso != null">AND nro_ingreso = #{nro_ingreso}</if>
			<if test="parameter != null">AND cast(${parameter} as varchar) like '${value}'</if>
			<if test="estado != null">AND estado = #{estado}</if>
			<if test="atendida != null">AND atendida = #{atendida}</if>
			<if test="atendiendo != null">AND atendiendo = #{atendiendo}</if>
			<if test="via_ingreso_cons != null">AND via_ingreso = #{via_ingreso_cons}</if>
			<if test="via_ingreso_urg != null">AND via_ingreso = #{via_ingreso_urg}</if>
			<if test="via_ingreso != null">AND via_ingreso = #{via_ingreso}</if>
			<if test="codigo_medico != null">AND (codigo_medico = #{codigo_medico} or
				codigo_medico =
				'000000000')
			</if>
			<if test="facturadas_manual != null">
				AND facturadas_manual = #{facturadas_manual}
			</if>
			<if test="fecha_apertura != null">AND fecha_apertura is not null</if>
			<if test="creacion_user != null">AND (creacion_user = #{creacion_user})</if>
			<if test="codigo_medico_mod != null">AND (codigo_medico = #{codigo_medico_mod})</if>
			<if test="fecha != null">AND cast(fecha_ingreso as varchar) like
				'${fecha}%'</if>
			<if test="causa_externa">AND causa_externa = #{causa_externa}</if>
			<if test="paramTodo != null">AND (
				nro_identificacion like '%${value}%'
				or
				nombre1||'
				'||nombre2 like '%${value}%'
				or apellido1||'
				'||apellido2 like
				'%${value}%'
				or nro_ingreso like '%${value}%')
			</if>
			<if test="aplica_triage != null">
				AND aplica_triage = #{aplica_triage}
			</if>
			<if test="realizo_triage != null">
				AND realizo_triage = #{realizo_triage}
			</if>
			<if test="marca_admision !=null">
				AND marca_admision = #{marca_admision}
			</if>

			<if test="validacion_tipo_historia != null">
				AND (primera_vez = 'N' OR
				(primera_vez =
				'S' AND
				via_ingreso = '14'))
			</if>
			<if test="filtro_urgencias != null">
				AND (aplica_triage = false OR
				(aplica_triage = true AND
				realizo_triage = true AND estado='1'))
			</if>
			<if test="vias_ingreso != null">
				AND via_ingreso IN
				<foreach collection="vias_ingreso" item="i" open="("
					separator="," close=")">
					#{i}
				</foreach>
			</if>
			<if test="vias_ingreso_excluyentes != null">
				AND via_ingreso NOT IN
				<foreach collection="vias_ingreso_excluyentes" item="i"
					open="(" separator="," close=")">
					#{i}
				</foreach>
			</if>
			<if test="tipo_adicional_via_ingreso != null">
				AND tipo_adicional_via_ingreso IN
				<foreach collection="tipo_adicional_via_ingreso" item="adicional"
					open="(" separator="," close=")">
					#{adicional}
				</foreach>
			</if>
			<if test="causa_externa_in != null">
				AND causa_externa IN
				<foreach collection="causa_externa_in" item="i" open="("
					separator="," close=")">
					#{i}
				</foreach>
			</if>

			<if test="codigo_centro != null">
				AND codigo_centro = #{codigo_centro}
			</if>

			<if test="centro_atencion != null">
				AND codigo_centro = #{centro_atencion}
			</if>

			<if test="listado_centros != null">
				AND codigo_centro IN
				<foreach collection="listado_centros" item="i" open="("
					separator="," close=")">
					#{i}
				</foreach>
			</if>

			<if test="fecha_inicial_p != null">
				<![CDATA[
				AND (cast(fecha_ingreso as date) >= cast(#{fecha_inicial_p} as date))
				]]>
			</if>

			<if test="fecha_final_p != null">
				<![CDATA[
				AND (cast(fecha_ingreso as date) <= cast(#{fecha_final_p} as date))
				]]>
			</if>

			<if test="rango_fecha != null">
				and cast(fecha_ingreso as date) between
				cast(#{fecha_inicio} as date)
				and cast(#{fecha_final} as date)
			</if>
		</trim>

	</select>

	<select id="listar_oportunidad" resultMap="admisionMap"
		parameterType="java.util.Map">
		select distinct admision.codigo_cita,citas.fecha_cita,
		admision.fecha_ingreso,admision.creacion_date,
		admision.fecha_atencion,admision.fecha_apertura,
		admision.codigo_empresa,admision.codigo_sucursal,
		admision.nro_ingreso,admision.nro_identificacion,
		admision.codigo_administradora,admision.id_plan,
		admision.codigo_medico,admision.estado,
		admision.via_ingreso,admision.primera_vez,
		admision.tipo_diagnostico,admision.diagnostico_ingreso,
		admision.ultimo_update,admision.delete_date,admision.creacion_user,
		admision.ultimo_user,admision.delete_user,
		admision.urgencias,admision.hospitalizacion,
		admision.recien_nacido,admision.atendida,admision.atendiendo,
		admision.aplica_triage,admision.realizo_triage,
		admision.aplica_tuberculosis,
		admision.codigo_orden,admision.aplica_lepra,admision.tipo_consulta,
		admision.tipo_adicional_via_ingreso,
		admision.admision_parto,admision.codigo_centro,
		admision.paciente_remitido,admision.procedencia,
		admision.particular,marca_admision,
		admision.tipo_psicologia,motivo_cancelacion,admision.facturadas_manual,
		admision.programa_lab_pyp,
		t2.codigo_empresa as pcodigo_empresa,
		t2.codigo_sucursal as pcodigo_sucursal,
		t2.documento as
		pdocumento,
		t2.nro_identificacion
		as pnro_identificacion,
		t2.nombre1 as
		pnombre1,
		t2.nombre2 as pnombre2,
		t2.apellido1 as
		papellido1,
		t2.apellido2 as
		papellido2,
		t2.tipo_identificacion as
		ptipo_identificacion,
		t2.codigo_educativo as
		pcodigo_educativo,
		t2.pertenencia_etnica as
		ppertenencia_etnica,
		t2.sexo as psexo,
		t2.direccion as pdireccion,
		t2.tel_res as ptel_res,
		t2.tel_oficina as
		ptel_oficina,
		t2.fecha_nacimiento as
		pfecha_nacimiento,
		t2.estado_civil
		as
		pestado_civil,
		t2.codigo_ocupacion as pcodigo_ocupacion,
		t2.codigo_dpto
		as
		pcodigo_dpto,
		t2.codigo_municipio as pcodigo_municipio,
		t2.tipo_usuario
		as ptipo_usuario,
		t2.unidad_medidad as punidad_medidad,
		t2.identificacion_madre as pidentificacion_madre,
		evi.codigo as
		evi_codigo,
		evi.tipo as evi_tipo,
		evi.descripcion as evi_descripcion,
		adm.codigo as acodigo_administradora,
		adm.nombre as
		anombre_administradora,
		pln.id_plan as plid_plan,
		pln.nombre as
		plnombre_plan
		from public.admision
		left join paciente t2 ON
		(admision.codigo_empresa=t2.codigo_empresa
		and
		admision.codigo_sucursal=t2.codigo_sucursal
		and
		admision.nro_identificacion=t2.nro_identificacion)
		left join elemento
		evi ON
		(admision.via_ingreso = evi.codigo AND
		evi.tipo ='via_ingreso')
		left join administradora adm ON
		(admision.codigo_administradora =
		adm.codigo)
		left join contratos pln
		ON
		(admision.codigo_empresa =
		pln.codigo_empresa AND
		admision.codigo_sucursal = pln.codigo_sucursal
		AND
		admision.codigo_administradora = pln.codigo_administradora AND
		admision.id_plan = pln.id_plan)
		left join prestadores prst ON
		(admision.codigo_empresa=prst.codigo_empresa
		and
		admision.codigo_sucursal=prst.codigo_sucursal
		and
		admision.codigo_medico=prst.nro_identificacion)

		left join citas citas
		ON
		(admision.codigo_empresa=citas.codigo_empresa
		and
		admision.codigo_sucursal=citas.codigo_sucursal
		and
		admision.codigo_cita=citas.codigo_cita)

		<trim prefix="WHERE" prefixOverrides="AND |OR ">
			<if test="codigo_empresa != null">AND admision.codigo_empresa = #{codigo_empresa}</if>
			<if test="codigo_sucursal != null">AND admision.codigo_sucursal = #{codigo_sucursal}</if>
			<if test="nro_identificacion != null">AND admision.nro_identificacion = #{nro_identificacion}
			</if>

			<if test="parameter != null">AND cast(${parameter} as varchar) like '${value}'</if>
			<if test="estado != null">AND admision.estado = #{estado}</if>
			<if test="atendida != null">AND admision.atendida = #{atendida}</if>
			<if test="atendiendo != null">AND admision.atendiendo = #{atendiendo}</if>
			<if test="via_ingreso_cons != null">AND admision.via_ingreso = #{via_ingreso_cons}</if>
			<if test="via_ingreso_urg != null">AND admision.via_ingreso = #{via_ingreso_urg}</if>
			<if test="via_ingreso != null">AND admision.via_ingreso = #{via_ingreso}</if>
			<if test="codigo_medico != null">AND (admision.codigo_medico = #{codigo_medico} or
				admision.codigo_medico = '000000000')
			</if>
			<if test="creacion_user != null">AND (admision.creacion_user = #{creacion_user})</if>
			<if test="codigo_medico_mod != null">AND (admision.codigo_medico = #{codigo_medico_mod})</if>
			<if test="fecha != null">AND cast(admision.fecha_ingreso as varchar) like
				'${fecha}%'</if>
			<if test="causa_externa">AND admision.causa_externa = #{causa_externa}</if>
			<if test="paramTodo != null">AND (
				t2.nro_identificacion like '%${value}%'
				or
				t2.nombre1||' '||t2.nombre2 like '%${value}%'
				or t2.apellido1||'
				'||t2.apellido2 like '%${value}%'
				or admision.nro_ingreso like
				'%${value}%'
				or
				cast(fecha_ingreso as varchar) like '${value}%'
				or
				prst.nro_identificacion like '${value}%'
				or prst.nombres like
				'${value}%'
				or prst.apellidos like '${value}%'
				)
			</if>

			<if test="vias_ingreso != null">
				AND admision.via_ingreso IN
				<foreach collection="vias_ingreso" item="i" open="("
					separator="," close=")">
					#{i}
				</foreach>
			</if>
			<if test="vias_ingreso_excluyentes != null">
				AND admision.via_ingreso NOT IN
				<foreach collection="vias_ingreso_excluyentes" item="i"
					open="(" separator="," close=")">
					#{i}
				</foreach>
			</if>
			<if test="tipo_adicional_via_ingreso != null">
				AND admision.tipo_adicional_via_ingreso IN
				<foreach collection="tipo_adicional_via_ingreso" item="adicional"
					open="(" separator="," close=")">
					#{adicional}
				</foreach>
			</if>

			<if test="codigo_centro != null">
				AND admision.codigo_centro = #{codigo_centro}
			</if>

			<if test="fecha_inicial_p != null">
				<![CDATA[
				AND (to_char(fecha_ingreso, 'yyyy-MM-dd') >= to_char(to_date('${fecha_inicial_p}','yyyy-MM-dd'),'yyyy-MM-dd'))
				]]>
			</if>

			<if test="fecha_final_p != null">
				<![CDATA[
				AND (to_char(fecha_ingreso, 'yyyy-MM-dd') <= to_char(to_date('${fecha_final_p}', 'yyyy-MM-dd'),'yyyy-MM-dd'))
				]]>
			</if>

			<if test="rango_fecha != null">
				and cast(fecha_ingreso as date) between
				cast(#{fecha_inicio} as date)
				and cast(#{fecha_final} as date)
			</if>

			<if test="fecha_ingreso != null">
				AND cast(admision.creacion_date as date) =
				#{fecha_ingreso}
			</if>

			<if test="fecha_atencion != null">
				AND cast(admision.fecha_apertura as date) =
				#{fecha_atencion}
			</if>


		</trim>
		<if test="order != null">
			order by ${order}
		</if>
		<if test="order == null">
			order by admision.fecha_ingreso
			desc,admision.estado,admision.nro_ingreso
			desc,
			t2.apellido1,t2.apellido2,t2.nombre1,t2.nombre2
		</if>
		<if test="limit != null">
			${limit}
		</if>
	</select>


	<select id="consultarAdmisionDiasAnteriores" resultMap="admisionMap"
		parameterType="java.util.Map">
		select DISTINCT ON (admision.nro_identificacion)
		admision.codigo_empresa,admision.codigo_sucursal,
		admision.codigo_empresa,admision.codigo_sucursal,
		admision.nro_ingreso,admision.nro_identificacion,admision.codigo_administradora,admision.id_plan,
		admision.codigo_medico,admision.estado,admision.fecha_ingreso,admision.nro_autorizacion,
		admision.via_ingreso,admision.tipo_atencion,admision.codigo_especialidad,admision.cama,
		admision.ingreso_programa,admision.primera_vez,admision.condicion_usuaria,admision.causa_externa,
		admision.tipo_diagnostico,admision.diagnostico_ingreso,admision.tipo_discapacidad,admision.grado_discapacidad,
		admision.creacion_date,admision.ultimo_update,admision.delete_date,admision.creacion_user,
		admision.ultimo_user,admision.delete_user,admision.urgencias,admision.hospitalizacion,
		admision.recien_nacido,admision.atendida,admision.atendiendo,admision.codigo_cita,admision.paciente_remitido,
		admision.procedencia,fecha_apertura,admision.aplica_triage,
		admision.realizo_triage,
		admision.aplica_tuberculosis,
		admision.codigo_orden,admision.aplica_lepra,admision.tipo_consulta,
		admision.fecha_atencion,
		admision.admision_parto,
		admision.codigo_centro,
		admision.particular,marca_admision,
		admision.tipo_psicologia,motivo_cancelacion,admision.facturadas_manual,
		admision.programa_lab_pyp,
		t2.codigo_empresa as pcodigo_empresa,
		t2.codigo_sucursal as pcodigo_sucursal,
		t2.documento as pdocumento,
		t2.nro_identificacion as
		pnro_identificacion,
		admision.tipo_adicional_via_ingreso,admision.fecha_atencion,
		t2.nombre1 as pnombre1,
		t2.nombre2 as pnombre2,
		t2.apellido1 as
		papellido1,
		t2.apellido2 as papellido2,
		t2.tipo_identificacion as
		ptipo_identificacion,
		t2.codigo_educativo as pcodigo_educativo,
		t2.pertenencia_etnica as ppertenencia_etnica,
		t2.sexo as psexo,
		t2.direccion as pdireccion,
		t2.tel_res as ptel_res,
		t2.tel_oficina as
		ptel_oficina,
		t2.fecha_nacimiento as pfecha_nacimiento,
		t2.estado_civil
		as pestado_civil,
		t2.codigo_ocupacion as
		pcodigo_ocupacion,
		t2.codigo_dpto as pcodigo_dpto,
		t2.codigo_municipio
		as
		pcodigo_municipio,
		t2.tipo_usuario as ptipo_usuario,
		t2.unidad_medidad
		as punidad_medidad,
		t2.identificacion_madre as
		pidentificacion_madre,
		evi.codigo as evi_codigo,
		evi.tipo as evi_tipo,
		evi.descripcion as
		evi_descripcion,
		adm.codigo as
		acodigo_administradora,
		adm.nombre as
		anombre_administradora,
		pln.id_plan as plid_plan,
		pln.nombre as
		plnombre_plan
		from public.admision
		left join paciente t2 ON
		(admision.codigo_empresa=t2.codigo_empresa
		and
		admision.codigo_sucursal=t2.codigo_sucursal
		and
		admision.nro_identificacion=t2.nro_identificacion)
		left join elemento
		evi ON
		(admision.via_ingreso = evi.codigo AND
		evi.tipo ='via_ingreso')
		left join administradora adm ON
		(admision.codigo_administradora =
		adm.codigo)
		left join contratos pln
		ON
		(admision.codigo_empresa =
		pln.codigo_empresa AND
		admision.codigo_sucursal = pln.codigo_sucursal
		AND
		admision.codigo_administradora = pln.codigo_administradora AND
		admision.id_plan = pln.id_plan)
		WHERE admision.codigo_empresa =
		#{codigo_empresa}
		AND admision.codigo_sucursal = #{codigo_sucursal}
		AND
		admision.nro_identificacion = #{nro_identificacion}
		AND
		admision.fecha_ingreso BETWEEN #{fecha_incial} AND #{fecha_actual}
		ORDER BY admision.nro_identificacion, admision.fecha_ingreso DESC
	</select>

	<select id="existe" parameterType="java.util.Map" resultType="java.lang.Boolean">
		select count(1) != 0 AS exist from public.admision
		<trim prefix="WHERE" prefixOverrides="AND |OR ">
			<if test="codigo_empresa != null">
				AND codigo_empresa = #{codigo_empresa}
			</if>
			<if test="codigo_sucursal != null">
				AND codigo_sucursal = #{codigo_sucursal}
			</if>
			<if test="via_ingreso != null">
				AND via_ingreso = #{via_ingreso}
			</if>
		</trim>
	</select>

	<select id="getIdHistoria" resultType="java.lang.Long"
		parameterType="admision">
		SELECT codigo_historia
		FROM historia_clinica
		WHERE
		codigo_empresa = #{codigo_empresa}
		AND codigo_sucursal =
		#{codigo_sucursal}
		AND nro_identificacion = #{nro_identificacion}
		AND
		nro_ingreso = #{nro_ingreso}
		LIMIT 1;
	</select>

	<select id="consultarContieneServicios" resultType="java.lang.Boolean">
		SELECT
		contiene_servicios_admision(#{codigo_empresa},
		#{codigo_sucursal},
		#{nro_identificacion}, #{nro_ingreso});
	</select>

	<select id="getUltimaAutorizacion" resultType="java.util.HashMap"
		parameterType="java.util.Map">
		select
		codigo_empresa,
		codigo_sucursal,
		nro_ingreso,
		nro_identificacion,
		codigo_administradora,
		nro_autorizacion,
		via_ingreso
		from
		public.admision
		where
		codigo_empresa = #{codigo_empresa} and
		codigo_sucursal = #{codigo_sucursal} and
		nro_autorizacion =
		#{nro_autorizacion} and
		codigo_administradora =
		#{codigo_administradora} and
		estado != #{no_estado}
		ORDER BY
		nro_ingreso,nro_identificacion
		limit 1 offset 0
	</select>

	<select id="getFechaUltimoServicio" resultType="java.sql.Timestamp"
		parameterType="admision">
		SELECT fecha
		FROM vr_fecha_ultimo_servicio
		WHERE
		codigo_empresa = #{codigo_empresa}
		AND codigo_sucursal =
		#{codigo_sucursal}
		AND nro_identificacion = #{nro_identificacion}
		AND
		nro_ingreso = #{nro_ingreso}
		ORDER BY fecha DESC LIMIT 1;
	</select>
</mapper>
